# 4장. 이음매 모델 (The Seam Model)

## 이음매 (Seams)

이음매: 그 지점을 직접 수정하지 않고도 행위를 변경할 수 있는 지점.

이음매 부분의 행위를 바꿔치기 할 수 있다면

* 테스트를 위해 의존성을 제거하거나
* *Fake collaborator*를 주입하여 테스트 대상의 동작 방식을 감지할 수 있다.

*Enabling point*: 이음매의 행위를 선택할 수 있는 지점. 모든 이음매마다 존재함.

## 이음매의 종류

사용 가능한 이음매의 종류는 프로그래밍 언어에 따라 다르다.

### 전처리 이음매 (Preprocessing Seams)

컴파일 전에 전처리 단계가 있는 소수의 프로그래밍 언어(C, C++ 등)에서 이용 가능.

* 어떤 함수와 동일한 모양의 매크로를 선언하여 함수 호출하는 부분(이음매)을 수정하지 않고도 행위를 변경할 수 있다. 단, `#ifdef TESTING`(*enabling point*)일 때만 해당 매크로가 선언되도록 한다.

프로덕션 코드에서 단순 텍스트 치환을 넘어서는 전처리 기능을 많이 이용하는 것은 나쁘다.

### 링크 이음매 (Link Seams)

컴파일러가 중간 결과물을 생성하고, 이런 중간 결과물들이 엮여 하나의 프로그램으로 동작하는 종류의 프로그래밍 언어(C, C++, Java 등)에서 이용 가능.

* Java에서는 어떤 클래스와 동일한 이름의 *fake collaborator*를 다른 디렉토리에 만들어놓고, 테스트 시에 클래스패스(*enabling point*)를 조작하여 그 클래스를 생성할 때(이음매) 다른 클래스가 생성되게 할 수 있다.
* C, C++에서는 링크 이음매를 이용하기 위해서는 이음매에 해당하는 부분의 라이브러리와 컴파일 시 정적 링크가 일어나지 않도록 빌드 스크립트를 조정해야 할 수 있다.

링크 이음매는 '분리하기'에 많이 사용된다. '감지하기'에도 이용할 수 있지만, 손이 좀 더 간다.

링크 이음매의 *enabling point*는 항상 프로그램 코드 바깥(빌드/배포 스크립트 등)에 존재하기 때문에 사용하고 있음을 알기 어려울 때가 많다. 테스트와 프로덕션 환경의 차이가 눈에 띄기 쉽게 해두는 것이 좋다.

### 객체 이음매 (Object Seams)

객체지향 언어에서 가장 유용한 종류의 이음매.

특정 메써드에 인자(*enabling point*)로 넘어가는 객체를 테스트용 서브클래스 객체로 대체함으로써 해당 객체가 사용되는 곳(이음매)의 행위를 변경할 수 있다.

## 결론

전처리 이음매와 링크 이음매는 객체 이음매만큼 명시적이지 않고 테스트를 유지보수하기 어려우므로 다른 대안이 없을 경우에만 이용한다.

직접 그 부분을 수정하지 않고도 어떤 지점의 행위를 변경할 수 있는 방법은 여러 가지가 있을 수 있다. 이음매라는 관점에서 코드를 바라보는데 익숙해지면, 테스트 방법과 테스트 하기 쉬운 설계 방법에 대해 더 잘 알게 될 것이다.
